rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to get user role safely
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserRole() == 'admin';
    }
    
    // Helper function to check if user belongs to branch
    function belongsToBranch(branchId) {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branch_id == branchId || isAdmin());
    }
    
    // Helper function to validate payment data (for creation)
    function isValidPayment() {
      let data = request.resource.data;
      return data.keys().hasAll(['student_id', 'amount', 'branch_id', 'receipt_id']) &&
             data.amount is number &&
             data.amount > 0 &&
             data.amount <= 10000000 && // Max 10 million (adjust as needed)
             data.student_id is string &&
             data.branch_id is string &&
             data.receipt_id is string &&
             (!data.keys().hasAny(['method']) || data.method is string) &&
             (!data.keys().hasAny(['note']) || data.note is string || data.note == null);
    }
    
    // Helper function to validate payment update data
    function isValidPaymentUpdate() {
      let data = request.resource.data;
      // Ensure required fields are present (can be same as existing)
      return data.keys().hasAll(['student_id', 'amount', 'branch_id', 'receipt_id']) &&
             data.amount is number &&
             data.amount > 0 &&
             data.amount <= 10000000 &&
             data.student_id is string &&
             data.branch_id is string &&
             data.receipt_id is string &&
             (!data.keys().hasAny(['method']) || data.method is string) &&
             (!data.keys().hasAny(['note']) || data.note is string || data.note == null);
    }
    
    // Helper function to validate user data
    function isValidUserData() {
      let data = request.resource.data;
      return data.keys().hasAll(['role', 'full_name']) &&
             data.role is string &&
             data.role in ['parent', 'teacher', 'headmaster', 'accountant', 'admin'] &&
             data.full_name is string &&
             (!data.keys().hasAny(['branch_id']) || data.branch_id is string || data.branch_id == null);
    }

    // Users collection: users can read their own profile, admins can read all
    match /users/{userId} {
      allow read: if request.auth != null && 
        (request.auth.uid == userId || 
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && isAdmin()));
      
      allow create: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        isValidUserData() &&
        request.resource.data.role in ['parent','teacher','headmaster','accountant','admin'];
      
      allow update: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (
          // User can update their own profile (but not role)
          (request.auth.uid == userId && 
           (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']) || 
            request.resource.data.role == resource.data.role)) ||
          // Admin can update any user
          isAdmin()
        ) &&
        isValidUserData();
      
      allow delete: if request.auth != null && isAdmin();
    }

    // Branches: allow public read (needed for signup flow) but only admins can create/update/delete
    match /branches/{branchId} {
      // Allow anyone to read branch metadata (e.g., names) so unauthenticated users
      // can select a campus during signup. Writes are still restricted to admins.
      allow read: if true;
      allow create, update, delete: if request.auth != null && isAdmin();
    }

    // Students: admins and headmasters can create/update/delete, users in same branch can read
    match /students/{studentId} {
      allow read: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (belongsToBranch(resource.data.branch_id) ||
         resource.data.branch_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branch_id);
      
      allow create, update, delete: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        getUserRole() in ['admin','headmaster'] &&
        belongsToBranch(request.resource.data.branch_id);
    }

    // Payments: accountants, headmasters and admins can create/read/update/delete in their branch
    match /payments/{paymentId} {
      allow read: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (belongsToBranch(resource.data.branch_id) ||
         resource.data.branch_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branch_id);
      
      allow create: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        getUserRole() in ['accountant','headmaster','admin'] &&
        belongsToBranch(request.resource.data.branch_id) &&
        isValidPayment() &&
        request.resource.data.recorded_by == request.auth.uid;
      
      allow update: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        getUserRole() in ['accountant','headmaster','admin'] &&
        belongsToBranch(resource.data.branch_id) &&
        isValidPaymentUpdate() &&
        // Prevent changing student_id, branch_id, or receipt_id after creation
        request.resource.data.student_id == resource.data.student_id &&
        request.resource.data.branch_id == resource.data.branch_id &&
        request.resource.data.receipt_id == resource.data.receipt_id;
      
      allow delete: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        getUserRole() in ['accountant','headmaster','admin'] &&
        belongsToBranch(resource.data.branch_id);
    }
    
    // Security audit logs: only admins can read, system can write
    match /security_audit_logs/{logId} {
      allow read: if request.auth != null && isAdmin();
      allow write: if false; // Only server-side writes (via Cloud Functions)
    }

    // Fallback: deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
